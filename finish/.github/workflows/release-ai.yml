name: Release Notes (AI)

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: read

jobs:
  collect-metadata:
    name: Collect PR metadata
    runs-on: ubuntu-latest
    outputs:
      pr_count: ${{ steps.extract.outputs.pr_count }}
    steps:
      - uses: actions/checkout@v4

      - name: Collect merged pull request metadata
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const MAX_TITLE_CHARS = 200;
            const MAX_BODY_CHARS = 1200;

            function truncate(str, max) {
            if (!str) return '';
            const s = String(str);
            return s.length > max ? s.slice(0, max) + '...[truncated]' : s;
            }

            function sanitize(str) {
            if (!str) return '';
            return String(str).replace(/```/g, '`');
            }

            const commits = context.payload.commits ?? [];
            const prsByNumber = new Map();

            for (const commit of commits) {
              const associatedPrs = await github.paginate(
                github.rest.repos.listPullRequestsAssociatedWithCommit,
                {
                  owner,
                  repo,
                  commit_sha: commit.id,
                  per_page: 100,
                }
              );

              for (const pr of associatedPrs) {
                if (!pr.merged_at) continue;
                if (pr.base?.ref !== 'main') continue;

                if (!prsByNumber.has(pr.number)) {
                  prsByNumber.set(pr.number, {
                    number: pr.number,
                    title: truncate(sanitize(pr.title), MAX_TITLE_CHARS),
                    labels: (pr.labels ?? []).map(l => l.name),
                    author: pr.user?.login ?? null,
                    body: truncate(sanitize(pr.body ?? ''), MAX_BODY_CHARS),
                  });
                }
              }
            }

            const report = {
              generated_at: new Date().toISOString(),
              repository: `${owner}/${repo}`,
              pull_requests: Array.from(prsByNumber.values()),
            };

            fs.writeFileSync('release-report.json', JSON.stringify(report, null, 2));
            core.info(`Wrote release-report.json with ${report.pull_requests.length} merged PR(s).`);

            const prCount = report.pull_requests.length;
            core.setOutput('pr_count', String(prCount));

      - name: Upload release input artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-input
          path: release-report.json

  generate-release-notes:
    name: Generate release notes (Azure OpenAI)
    if: needs.collect-metadata.outputs.pr_count != '0'
    needs: collect-metadata
    runs-on: ubuntu-latest
    environment:
      name: devops-dev
    steps:
      - uses: actions/checkout@v4

      - name: Download release input artifact
        uses: actions/download-artifact@v4
        with:
          name: release-input

      - name: Generate release notes via reusable action
        id: aoai
        uses: ./.github/azure-openai-chat
        with:
          endpoint: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          api_key: ${{ secrets.AZURE_OPENAI_API_KEY }}
          deployment: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          api_version: "2024-02-15-preview"
          system_prompt_file: "ai/prompts/release-notes.prompt.md"
          user_input_file: "release-report.json"
          output_file: "release-notes.md"
          temperature: "0.1"

      - name: AI budget + performance warnings (annotations)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          # Soft thresholds (warn only). Tune per org.
          MAX_TOKENS=2000
          MAX_DURATION=10

          TOKENS="${{ steps.aoai.outputs.total_tokens }}"
          DURATION="${{ steps.aoai.outputs.duration_seconds }}"

          echo "Total tokens: ${TOKENS}"
          echo "Duration (s): ${DURATION}"

          # If outputs missing for any reason, don't fail the pipeline here.
          if [[ -z "${TOKENS}" || -z "${DURATION}" ]]; then
            echo "::warning::AI telemetry outputs missing; check action.yml outputs."
            exit 0
          fi

          if [[ "${TOKENS}" -gt "${MAX_TOKENS}" ]]; then
            echo "::warning::AI token usage (${TOKENS}) exceeded soft budget (${MAX_TOKENS}). Consider reducing metadata size or tightening truncation."
          fi

          if [[ "${DURATION}" -gt "${MAX_DURATION}" ]]; then
            echo "::warning::AI call duration (${DURATION}s) exceeded soft threshold (${MAX_DURATION}s). Potential latency regression."
          fi

      - name: Publish AI telemetry summary (Job Summary)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## AI Telemetry Summary"
            echo ""
            echo "- HTTP status: ${{ steps.aoai.outputs.http_status }}"
            echo "- Duration (seconds): ${{ steps.aoai.outputs.duration_seconds }}"
            echo "- Total tokens: ${{ steps.aoai.outputs.total_tokens }}"
            echo "- Prompt tokens: ${{ steps.aoai.outputs.prompt_tokens }}"
            echo "- Completion tokens: ${{ steps.aoai.outputs.completion_tokens }}"
            echo ""
            echo "### Notes"
            echo "- If token or duration warnings appear above, tune truncation (Lesson 5) or thresholds (Lesson 7)."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload release output artifact1
        uses: actions/upload-artifact@v4
        with:
          name: release-output
          path: |
            release-report.json
            release-notes.md
            .aoai.response.json
            ai-telemetry.json
            
      - name: Upload AI telemetry artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-telemetry
          path: ai-telemetry.json

  validate-release-notes:
    name: Validate deterministic contract
    needs: [collect-metadata, generate-release-notes]
    if: needs.collect-metadata.outputs.pr_count != '0'
    runs-on: ubuntu-latest
    steps:
      - name: Download release output artifact
        uses: actions/download-artifact@v4
        with:
          name: release-output

      - name: Validate headings + bullets
        run: |
          set -euo pipefail
          test -s release-notes.md

          grep -q "^## Features" release-notes.md
          grep -q "^## Fixes" release-notes.md
          grep -q "^## Infrastructure" release-notes.md
          grep -q "^## Breaking Changes" release-notes.md

          # Ensure each section has at least one bullet.
          awk '
            /^## /{h=$0; c=0; next}
            /^- /{c++}
            /^## /{ if (h != "" && c == 0) { print "No bullets under " h; exit 1 } }
            END{ if (h != "" && c == 0) { print "No bullets under " h; exit 1 } }
          ' release-notes.md

  publish-release:
    name: Publish draft GitHub Release
    needs: [collect-metadata, validate-release-notes]
    if: needs.collect-metadata.outputs.pr_count != '0'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download release output artifact
        uses: actions/download-artifact@v4
        with:
          name: release-output

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          draft: true
          tag_name: v0.1.${{ github.run_number }}