name: Collect Merged PR Metadata

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  collect-pr-metadata:
    runs-on: ubuntu-latest

    steps:
      - name: Collect merged pull request metadata
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const commits = context.payload.commits ?? [];
            const prsByNumber = new Map();

            for (const commit of commits) {
              const associatedPrs = await github.paginate(
                github.rest.repos.listPullRequestsAssociatedWithCommit,
                {
                  owner,
                  repo,
                  commit_sha: commit.id,
                  per_page: 100,
                }
              );

              for (const pr of associatedPrs) {
                if (!pr.merged_at) {
                  continue;
                }

                if (pr.base?.ref !== 'main') {
                  continue;
                }

                if (!prsByNumber.has(pr.number)) {
                  prsByNumber.set(pr.number, {
                    number: pr.number,
                    title: pr.title,
                    labels: (pr.labels ?? []).map((label) => label.name),
                    author: pr.user?.login ?? null,
                    body: pr.body ?? '',
                    merged_at: pr.merged_at,
                    html_url: pr.html_url,
                  });
                }
              }
            }

            const report = {
              generated_at: new Date().toISOString(),
              repository: `${owner}/${repo}`,
              push: {
                before: context.payload.before ?? null,
                after: context.payload.after ?? null,
                ref: context.payload.ref ?? null,
                commit_count: commits.length,
              },
              pull_requests: Array.from(prsByNumber.values()),
            };

            fs.writeFileSync('release-report.json', JSON.stringify(report, null, 2));
            core.info(`Wrote release-report.json with ${report.pull_requests.length} merged PR(s).`);

      - name: Generate release notes from metadata
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const report = JSON.parse(fs.readFileSync('release-report.json', 'utf8'));
            const pullRequests = report.pull_requests ?? [];

            const groups = [
              { heading: 'Features', label: 'release:minor' },
              { heading: 'Fixes', label: 'release:patch' },
              { heading: 'Breaking Changes', label: 'release:major' },
              { heading: 'Infrastructure', label: 'area:infra' },
            ];

            const lines = [];
            lines.push('# Release Notes');
            lines.push('');
            lines.push(`Generated: ${report.generated_at ?? ''}`);
            lines.push(`Repository: ${report.repository ?? ''}`);
            lines.push('');

            for (const group of groups) {
              lines.push(`## ${group.heading}`);

              const matching = pullRequests.filter((pr) =>
                (pr.labels ?? []).includes(group.label)
              );

              if (matching.length === 0) {
                lines.push('- None');
                lines.push('');
                continue;
              }

              for (const pr of matching) {
                const author = pr.author ?? 'unknown';
                const url = pr.html_url ?? '';
                const title = pr.title ?? '';
                const number = pr.number ?? '';
                lines.push(`- #${number} ${title} (@${author})${url ? ` - ${url}` : ''}`);

                const body = (pr.body ?? '').trim();
                if (body) {
                  lines.push('  - Body:');
                  for (const bodyLine of body.split(/\r?\n/)) {
                    lines.push(`    - ${bodyLine}`);
                  }
                }

                const labels = pr.labels ?? [];
                if (labels.length > 0) {
                  lines.push(`  - Labels: ${labels.join(', ')}`);
                }
              }

              lines.push('');
            }

            fs.writeFileSync('release-notes.md', lines.join('\n'));
            core.info('Wrote release-notes.md from release-report.json metadata.');

      - name: Upload release report artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-report
          path: |
            release-report.json
            release-notes.md
    
      - name: Validate release notes not empty
        run: |
            test -s release-notes.md || (echo "Release notes empty" && exit 1)

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
            body_path: release-notes.md
            draft: true

