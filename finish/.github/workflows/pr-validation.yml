name: PR Validation

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore src/GenAIDevOps.sln

      - name: Build (Release)
        run: dotnet build src/GenAIDevOps.sln --configuration Release --no-restore

      - name: Test with coverage (Release)
        run: >-
          dotnet test src/GenAIDevOps.sln --configuration Release --no-build
          /p:CollectCoverage=true
          /p:CoverletOutput=./TestResults/coverage/coverage
          /p:CoverletOutputFormat=cobertura
          /p:Threshold=70
          /p:ThresholdType=line

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: '**/TestResults/coverage/coverage.cobertura.xml'

  formatting-check:
    name: Formatting Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Verify formatting
        run: dotnet format src/GenAIDevOps.sln --verify-no-changes

  # dependency-review:
    # name: Dependency Review
    # runs-on: ubuntu-latest
    # steps:
    #   - name: Checkout
    #     uses: actions/checkout@v4

    #   - name: Dependency Review
    #     uses: actions/dependency-review-action@v4
    #     with:
    #      repo-token: ${{ secrets.GITHUB_TOKEN }}

  pr-summary:
    name: PR Summary Comment
    runs-on: ubuntu-latest
    needs:
      - build-test
      - formatting-check
      # - dependency-review
    steps:
      - name: Post PR summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            const pr = await github.rest.pulls.get({ owner, repo, pull_number });
            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const title = pr.data.title || "";
            const commitMessages = commits
              .map((commit) => commit.commit.message.split("\n")[0])
              .filter((message) => message && message.trim().length > 0);

            const combinedText = [title, ...commitMessages].join(" ").toLowerCase();

            const highRiskKeywords = [
              "security",
              "breaking",
              "migration",
              "data loss",
              "hotfix",
              "rollback",
            ];
            const lowRiskKeywords = [
              "docs",
              "readme",
              "chore",
              "cleanup",
              "refactor",
              "format",
            ];

            const infraKeywords = [
              "infra",
              "bicep",
              "terraform",
              "pipeline",
              "workflow",
              "azure",
              "deployment",
            ];

            const risk = highRiskKeywords.some((k) => combinedText.includes(k))
              ? "high"
              : lowRiskKeywords.some((k) => combinedText.includes(k))
                ? "low"
                : "medium";

            const infraImpact = infraKeywords.some((k) => combinedText.includes(k))
              ? "yes"
              : "no";

            const summaryLines = [
              `PR Title: ${title || "(no title)"}`,
              "Commit Messages:",
              ...(commitMessages.length > 0
                ? commitMessages.map((message) => `- ${message}`)
                : ["- (no commits)"]),
            ];

            const commentBody = [
              "<!-- pr-validation-summary -->",
              "## PR Summary (Deterministic)",
              "",
              "**Summary of changes**",
              ...summaryLines,
              "",
              `**Risk assessment**: ${risk}`,
              "",
              "**Testing considerations**: CI runs build/test/format/dependency review; add manual tests if needed.",
              "",
              `**Infra impact**: ${infraImpact}`,
            ].join("\n");

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pull_number,
              per_page: 100,
            });

            const existing = comments.find(
              (comment) =>
                comment.user.type === "Bot" &&
                comment.body.includes("<!-- pr-validation-summary -->")
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: commentBody,
              });
            }
